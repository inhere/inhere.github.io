<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Mysql的锁机制解读 | Inhere&#x27;s Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://inhere.github.io/blog/lock-intro-in-mysql"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Mysql的锁机制解读 | Inhere&#x27;s Site"><meta data-rh="true" name="description" content="Mysql的锁机制解读说明"><meta data-rh="true" property="og:description" content="Mysql的锁机制解读说明"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2016-09-07T21:17:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/inhere"><meta data-rh="true" property="article:tag" content="mysql,lock"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://inhere.github.io/blog/lock-intro-in-mysql"><link data-rh="true" rel="alternate" href="https://inhere.github.io/blog/lock-intro-in-mysql" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://inhere.github.io/en/blog/lock-intro-in-mysql" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://inhere.github.io/blog/lock-intro-in-mysql" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Inhere&#39;s Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Inhere&#39;s Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.326ec79b.css">
<link rel="preload" href="/assets/js/runtime~main.87f74f70.js" as="script">
<link rel="preload" href="/assets/js/main.0959c99e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_FWgj" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_fXWX"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/inhere-s03.png" alt="Inhere&#x27;s Site Logo" class="themedImage_mt67 themedImage--light_fX3w"><img src="/img/inhere-s03.png" alt="Inhere&#x27;s Site Logo" class="themedImage_mt67 themedImage--dark_uZcq"></div><b class="navbar__title text--truncate">Inhere&#x27;s Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/blog/tags">Tags</a><a class="navbar__item navbar__link" href="/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/projects">Projects</a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage__gi4"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文（中国）</a><ul class="dropdown__menu"><li><a href="/blog/lock-intro-in-mysql" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中文（中国）</a></li><li><a href="/en/blog/lock-intro-in-mysql" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-GB">English</a></li></ul></div><a href="https://github.com/inhere" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_jIwi"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_Xqq4 colorModeToggle_z0Ih"><button class="clean-btn toggleButton_CURL toggleButtonDisabled_Le21" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_tmUv"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_YNUG"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_MNsY"><div class="navbar__search searchBarContainer_pu4W"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_fD50 searchBarLoadingRing_THOz"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_BOxT"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_pCHW thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_JQVx margin-bottom--md">📅最近文章</div><ul class="sidebarItemList_z5Cd clean-list"><li class="sidebarItem_ubWi"><a class="sidebarItemLink_C1cL" href="/blog/gookit-goutil-release-v0.6.10">gookit/goutil - 发布 v0.6.10 版本, Go常用功能的扩展工具库</a></li><li class="sidebarItem_ubWi"><a class="sidebarItemLink_C1cL" href="/blog/gookit-slog-release-v0.5.2">gookit/slog - 发布 v0.5.2 版本, 易于使用的，可配置、可扩展的Go日志库</a></li><li class="sidebarItem_ubWi"><a class="sidebarItemLink_C1cL" href="/blog/gookit-event-pacakge-intro">gookit/event - Go实现的轻量级的事件管理、调度程序库</a></li><li class="sidebarItem_ubWi"><a class="sidebarItemLink_C1cL" href="/blog/install-log-search-zincobserve-by-docker">通过docker安装日志搜索服务 zincobserve(openobserve)</a></li><li class="sidebarItem_ubWi"><a class="sidebarItemLink_C1cL" href="/blog/gookit-config-intro">gookit/config - Go语言读取多种格式配置文件</a></li><li class="sidebarItem_ubWi"><a class="sidebarItemLink_C1cL" href="/blog/install-tools-by-scoop-on-windows">通过 scoop 在Windows 下安装工具</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_RJHB" itemprop="headline">Mysql的锁机制解读</h1><div class="container_zCGu margin-vert--md"><time datetime="2016-09-07T21:17:00.000Z" itemprop="datePublished">2016年9月7日</time> · <!-- -->阅读需 14 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_DmgG"><div class="avatar margin-bottom--sm"><a href="https://github.com/inhere" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/inhere.png" alt="inhere"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/inhere" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">inhere</span></a></div><small class="avatar__subtitle" itemprop="description">docs maintainer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Mysql的锁机制解读说明</p><h2 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="基本概念">基本概念<a href="#基本概念" class="hash-link" aria-label="基本概念的直接链接" title="基本概念的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="共享锁">共享锁<a href="#共享锁" class="hash-link" aria-label="共享锁的直接链接" title="共享锁的直接链接">​</a></h3><p>共享锁的代号是<code>S</code>，是Share的缩写，共享锁的锁粒度是行或者元组（多个行）。一个事务获取了共享锁之后，可以对锁定范围内的数据<strong>执行读操作</strong>。 </p><h3 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="排它锁">排它锁<a href="#排它锁" class="hash-link" aria-label="排它锁的直接链接" title="排它锁的直接链接">​</a></h3><p>排它锁的代号是<code>X</code>，是eXclusive的缩写，排它锁的粒度与共享锁相同，也是行或者元组。一个事务获取了排它锁之后，可以对锁定范围内的数据<strong>执行写操作</strong>。</p><p>例：假设有两个事务t1和t2</p><p>如果事务t1获取了一个元组的共享锁，事务t2还可以立即获取这个元组的共享锁，但不能立即获取这个元组的排它锁（必须等到t1释放共享锁之后）。
如果事务t1获取了一个元组的排它锁，事务t2不能立即获取这个元组的排共享锁，也不能立即获取这个元组的排它锁（必须等到t1释放排它锁之后）。</p><h3 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="意向锁">意向锁<a href="#意向锁" class="hash-link" aria-label="意向锁的直接链接" title="意向锁的直接链接">​</a></h3><p>意向锁是<strong>一种表锁，锁定的粒度是整张表</strong>，分为<strong>意向共享锁(IS)</strong>和<strong>意向排它锁(IX)</strong>两类。</p><p>意向共享锁表示一个事务有意对数据上共享锁或者排它锁。“有意”这两个字表达的意思比较微妙，说的明白点就是指事务想干这个事但还没真去干。
举例说明下意向共享锁，比如一个事务t执行了这样一个语句：<code>select * from table lock in share model</code> ，如果这个语句执行成功，就对表table上了一个意向共享锁。
<code>lock in share model</code> 就是说事务t1在接下来要执行的语句中要获取S锁。如果t1的<code>select * from table lock in share model</code>执行成功，那么接下来t1应该可以畅通无阻的去执行只需要共享锁的语句了。</p><p>意向排它锁的含义同理可知，上例中要获取意向排它锁，可以使用<code>select * from table for update</code> 。</p><p><code>lock in share model</code> 和 <code>for update</code>这两个东西在数据率理论中还有个学名叫<strong>悲观锁</strong>，与悲观锁相对的当然还有乐观锁。大家可以看到各种锁都是成双成对出现的。关于悲观锁和乐观锁的问题暂且不表。 </p><h3 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="锁的互斥与兼容关系">锁的互斥与兼容关系<a href="#锁的互斥与兼容关系" class="hash-link" aria-label="锁的互斥与兼容关系的直接链接" title="锁的互斥与兼容关系的直接链接">​</a></h3><p>锁和锁之间的关系，要么是相容的，要么是互斥的。
锁a和锁b相容是指：操作同样一组数据时，如果事务t1获取了锁a,另一个事务t2还可以获取锁b；
锁a和锁b互斥是指：操作同样一组数据时，如果事务t1获取了锁a，另一个事务t2在t1释放锁a之前无法获取锁b。</p><p>上面提到的共享锁、排它锁、意向共享锁、意向排它锁相互之前都是有兼容/互斥关系的，可以用一个兼容性矩阵表示(y表示兼容，n表示不兼容):</p><div class="codeBlockContainer_qBuI theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_s4cj"><pre tabindex="0" class="prism-code language-text codeBlock_ZB_v thin-scrollbar"><code class="codeBlockLines_iNkr"><span class="token-line" style="color:#393A34"><span class="token plain">    X    S    IX    IS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">X  n     n    n     n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">S  n     y    n     y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IX n     n    y     y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IS n     y    y     y  </span><br></span></code></pre><div class="buttonGroup_MJM4"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_rG_2" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_l0xu"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_DXTq"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>兼容性矩阵为什么是这个样子的？</p><p>X和S的相互关系在上文中解释过了，IX和IS的相互关系全部是兼容，这也很好理解，因为它们都只是“有意”，还处于YY阶段，没有真干，所以是可以兼容的；
剩下的就是X和IX，X和IS, S和IX， S和IS的关系了，我们可以由X和S的关系推导出这四组关系。</p><p>简单的说：X和IX的=X和X的关系。为什么呢？因为事务在获取IX锁后，接下来就有权利获取X锁。如果X和IX兼容的话，就会出现两个事务都获取了X锁的情况，这与我们已知的X与X互斥是矛盾的，所以X与IX只能是互斥关系。</p><p>其余的三组关系同理，可用同样的方式推导出来。</p><h2 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="mysql有三种锁的级别页级表级行级">MySQL有三种锁的级别：页级、表级、行级。<a href="#mysql有三种锁的级别页级表级行级" class="hash-link" aria-label="MySQL有三种锁的级别：页级、表级、行级。的直接链接" title="MySQL有三种锁的级别：页级、表级、行级。的直接链接">​</a></h2><p>MyISAM和MEMORY存储引擎采用的是<strong>表级锁（table-level locking）</strong>；
BDB存储引擎采用的是<strong>页面锁（page-level locking）</strong>，但也支持表级锁；
InnoDB存储引擎既支持<strong>行级锁（row-level locking）</strong>，也支持表级锁，但默认情况下是采用行级锁。</p><p>MySQL这3种锁的特性可大致归纳如下：</p><ul><li>表级锁：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高,并发度最低。</li><li>行级锁：开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低,并发度也最高。</li><li>页面锁：开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="myisam表锁">MyISAM表锁<a href="#myisam表锁" class="hash-link" aria-label="MyISAM表锁的直接链接" title="MyISAM表锁的直接链接">​</a></h2><p>MyISAM存储引擎只支持表锁，是现在用得最多的存储引擎。</p><h3 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="1查询表级锁争用情况">1、查询表级锁争用情况<a href="#1查询表级锁争用情况" class="hash-link" aria-label="1、查询表级锁争用情况的直接链接" title="1、查询表级锁争用情况的直接链接">​</a></h3><p>可以通过检查table_locks_waited和table_locks_immediate状态变量来分析系统上的表锁定争夺：
mysql&gt; show status like ‘table%’;
+———————–+———-+
| Variable_name | Value |
+———————–+———-+
| Table_locks_immediate | 76939364 |
| Table_locks_waited | 305089 |
+———————–+———-+
2 rows in set (0.00 sec)Table_locks_waited的值比较高，说明存在着较严重的表级锁争用情况。</p><h3 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="2mysql表级锁的锁模式">2、MySQL表级锁的锁模式<a href="#2mysql表级锁的锁模式" class="hash-link" aria-label="2、MySQL表级锁的锁模式的直接链接" title="2、MySQL表级锁的锁模式的直接链接">​</a></h3><p>MySQL的表级锁有两种模式：<strong>表共享读锁（Table Read Lock）</strong>和 <strong>表独占写锁（Table Write Lock）</strong>。</p><blockquote><p>MyISAM在执行查询语句（SELECT）前，会自动给涉及的所有表加读锁，在执行更新操作（UPDATE、DELETE、INSERT等）前，会自动给涉及的表加写锁。</p></blockquote><p>所以对MyISAM表进行操作，会有以下情况：</p><p>a. 对MyISAM表的读操作（加读锁），不会阻塞其他进程对同一表的读请求，但会阻塞对同一表的写请求。只有当读锁释放后，才会执行其它进程的写操作。
b. 对MyISAM表的写操作（加写锁），会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其它进程的读写操作。</p><p>下面通过例子来进行验证以上观点。数据表gz_phone里有二百多万数据，字段id,phone,ua,day。现在同时用多个客户端同时对该表进行操作分析。</p><p>a、当我用客户端1进行一个比较长时间的读操作时，分别用客户端2进行读和写操作：</p><div class="codeBlockContainer_qBuI theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_s4cj"><pre tabindex="0" class="prism-code language-text codeBlock_ZB_v thin-scrollbar"><code class="codeBlockLines_iNkr"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt;select count(*) from gz_phone group by ua;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">75508 rows in set (3 min 15.87 sec) client2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select id,phone from gz_phone limit 1000,10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+——+——-+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | phone |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+——+——-+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1001 | 2222 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1002 | 2222 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1003 | 2222 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1004 | 2222 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1005 | 2222 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1006 | 2222 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1007 | 2222 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1008 | 2222 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1009 | 2222 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1010 | 2222 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+——+——-+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10 rows in set (0.01 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; update gz_phone set phone=’11111111111′where id=1001;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query OK, 0 rows affected (2 min 57.88 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rows matched: 1 Changed: 0 Warnings: 0</span><br></span></code></pre><div class="buttonGroup_MJM4"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_rG_2" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_l0xu"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_DXTq"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>说明当数据表有一个读锁时，其它进程的查询操作可以马上执行，但更新操作需等待读锁释放后才会执行。</p><p>b、当用客户端1进行一个较长时间的更新操作时，用客户端2,3分别进行读写操作：</p><div class="codeBlockContainer_qBuI theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_s4cj"><pre tabindex="0" class="prism-code language-text codeBlock_ZB_v thin-scrollbar"><code class="codeBlockLines_iNkr"><span class="token-line" style="color:#393A34"><span class="token plain">client1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; update gz_phone set phone=’11111111111′;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query OK, 1671823 rows affected (3 min 4.03 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rows matched: 2212070 Changed: 1671823 Warnings: 0 client2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; select id,phone,ua,day from gz_phone limit 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+—-+——-+——————-+————+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | phone | ua | day |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+—-+——-+——————-+————+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 1 | 2222 | SonyEricssonK310c | 2007-12-19 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 2 | 2222 | SonyEricssonK750c | 2007-12-19 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 3 | 2222 | MAUI WAP Browser | 2007-12-19 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 4 | 2222 | Nokia3108 | 2007-12-19 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 5 | 2222 | LENOVO-I750 | 2007-12-19 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 6 | 2222 | BIRD_D636 | 2007-12-19 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 7 | 2222 | SonyEricssonS500c | 2007-12-19 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 8 | 2222 | SAMSUNG-SGH-E258 | 2007-12-19 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 9 | 2222 | NokiaN73-1 | 2007-12-19 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 10 | 2222 | Nokia2610 | 2007-12-19 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+—-+——-+——————-+————+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10 rows in set (2 min 58.56 sec) client3:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; update gz_phone set phone=’55555′where id=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query OK, 1 row affected (3 min 50.16 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rows matched: 1 Changed: 1 Warnings: 0</span><br></span></code></pre><div class="buttonGroup_MJM4"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_rG_2" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_l0xu"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_DXTq"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>说明当数据表有一个写锁时，其它进程的读写操作都需等待读锁释放后才会执行。</p><h3 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="3并发插入">3、并发插入<a href="#3并发插入" class="hash-link" aria-label="3、并发插入的直接链接" title="3、并发插入的直接链接">​</a></h3><p>原则上数据表有一个读锁时，其它进程无法对此表进行更新操作，但在一定条件下，MyISAM表也支持查询和插入操作的并发进行。</p><p>MyISAM存储引擎有一个系统变量concurrent_insert，专门用以控制其并发插入的行为，其值分别可以为0、1或2。</p><p>a. 当concurrent_insert设置为0时，不允许并发插入。
b. 当concurrent_insert设置为1时，如果MyISAM表中没有空洞（即表的中间没有被删除的行），MyISAM允许在一个进程读表的同时，另一个进程从表尾插入记录。这也是MySQL的默认设置。
c. 当concurrent_insert设置为2时，无论MyISAM表中有没有空洞，都允许在表尾并发插入记录。</p><h3 class="anchor anchorWithHideOnScrollNavbar_kOCw" id="4myisam的锁调度">4、MyISAM的锁调度<a href="#4myisam的锁调度" class="hash-link" aria-label="4、MyISAM的锁调度的直接链接" title="4、MyISAM的锁调度的直接链接">​</a></h3><p>由于MySQL认为写请求一般比读请求要重要，所以如果有读写请求同时进行的话，MYSQL将会优先执行写操作。这样MyISAM表在进行大量的更新操作时（特别是更新的字段中存在索引的情况下），会造成查询操作很难获得读锁，从而导致查询阻塞。</p><p>我们可以通过一些设置来调节MyISAM的调度行为：</p><p>a. 通过指定启动参数<code>low-priority-updates</code>，使MyISAM引擎默认给予读请求以优先的权利。
b. 通过执行命令<code>SET LOW_PRIORITY_UPDATES=1</code>，使该连接发出的更新请求优先级降低。
c. 通过指定 <code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code> 语句的<code>LOW_PRIORITY</code>属性，降低该语句的优先级。</p><p>上面3种方法都是要么更新优先，要么查询优先的方法。这里要说明的就是，不要盲目的给mysql设置为读优先，因为一些需要长时间运行的查询操作，也会使写进程“饿死”。只有根据你的实际情况，来决定设置哪种操作优先。这些方法还是没有从根本上同时解决查询和更新的问题。</p><p>在一个有大数据量高并发表的mysql里，我们还可采用另一种策略来进行优化，那就是通过mysql主从（读写）分离来实现负载均衡，这样可避免优先哪一种操作从而可能导致另一种操作的堵塞。</p><blockquote><p>转自：<a href="http://blog.csdn.net/andyxm/article/details/44810313" target="_blank" rel="noopener noreferrer">CSDN博客</a></p></blockquote></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_s3wJ"><div class="col"><b>标签：</b><ul class="tags_s874 padding--none margin-left--sm"><li class="tag_MJCD"><a class="tag_dsT9 tagRegular_S8DR" href="/blog/tags/mysql">mysql</a></li><li class="tag_MJCD"><a class="tag_dsT9 tagRegular_S8DR" href="/blog/tags/lock">lock</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/inhere/inhere.github.io/tree/main/blog/2016/09-07-lock-intro-in-mysql.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mu1i" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/sec-command-usage-in-linux"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">linux 命令 sed 详解</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/lsof-command-usage-in-linux"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Linux 命令神器 lsof 入门</div></a></nav></main><div class="col col--2"><div class="tableOfContents_YRvJ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#基本概念" class="table-of-contents__link toc-highlight">基本概念</a><ul><li><a href="#共享锁" class="table-of-contents__link toc-highlight">共享锁</a></li><li><a href="#排它锁" class="table-of-contents__link toc-highlight">排它锁</a></li><li><a href="#意向锁" class="table-of-contents__link toc-highlight">意向锁</a></li><li><a href="#锁的互斥与兼容关系" class="table-of-contents__link toc-highlight">锁的互斥与兼容关系</a></li></ul></li><li><a href="#mysql有三种锁的级别页级表级行级" class="table-of-contents__link toc-highlight">MySQL有三种锁的级别：页级、表级、行级。</a></li><li><a href="#myisam表锁" class="table-of-contents__link toc-highlight">MyISAM表锁</a><ul><li><a href="#1查询表级锁争用情况" class="table-of-contents__link toc-highlight">1、查询表级锁争用情况</a></li><li><a href="#2mysql表级锁的锁模式" class="table-of-contents__link toc-highlight">2、MySQL表级锁的锁模式</a></li><li><a href="#3并发插入" class="table-of-contents__link toc-highlight">3、并发插入</a></li><li><a href="#4myisam的锁调度" class="table-of-contents__link toc-highlight">4、MyISAM的锁调度</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/inhere" target="_blank" rel="noopener noreferrer" class="footer__link-item">Inhere GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_jIwi"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/gookit" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gookit GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_jIwi"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/phppkg" target="_blank" rel="noopener noreferrer" class="footer__link-item">PHPPkg GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_jIwi"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/blog/tags">Blog Tags</a></li><li class="footer__item"><a class="footer__link-item" href="/blog/archive">Blog Archives</a></li><li class="footer__item"><a href="https://github.com/inhere/inhere.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Site GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_jIwi"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc.
         Built with <a target="block" href="https://github.com/facebook/docusaurus">Docusaurus</a>.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.87f74f70.js"></script>
<script src="/assets/js/main.0959c99e.js"></script>
</body>
</html>